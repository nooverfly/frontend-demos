<!DOCTYPE html>
<html>
  <head>
    <title>point</title>

    <script
      type="text/javascript"
      src="https://unpkg.com/dat.gui@0.7.6/build/dat.gui.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/gcoord@0.2.3/dist/gcoord.js"
    ></script>
    <link
      type="text/css"
      rel="stylesheet"
      href="https://unpkg.com/maptalks/dist/maptalks.css"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/maptalks/dist/maptalks.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/@maptalks/gl/dist/maptalksgl.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/three@0.138.0/build/three.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/maptalks.three@latest/dist/maptalks.three.js"
    ></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/three@0.138.0/examples/js/libs/stats.min.js"
    ></script>
    <style>
      html,
      body {
        margin: 0px;
        height: 100%;
        width: 100%;
      }

      #map {
        width: 100%;
        height: 100%;
        background-color: #000;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      var map = new maptalks.Map("map", {
        center: [114.02886943761405, 22.536328869597213],
        zoom: 13,
        pitch: 12.000000000000057,
        bearing: -3.0000000000001137,

        centerCross: true,
        doubleClickZoom: false,
        baseLayer: new maptalks.TileLayer("tile", {
          urlTemplate:
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
          subdomains: ["a", "b", "c", "d"],
          attribution:
            '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>',
        }),
      });

      // the ThreeLayer to draw buildings
      var threeLayer = new maptalks.ThreeLayer("t", {
        forceRenderOnMoving: true,
        forceRenderOnRotating: true,
        // animation: true
      });
      threeLayer.prepareToDraw = function (gl, scene, camera) {
        addPoints(scene);
      };
      const sceneConfig = {
        postProcess: {
          enable: true,
          antialias: { enable: true },
        },
      };
      const groupLayer = new maptalks.GroupGLLayer("group", [threeLayer], {
        sceneConfig,
      });
      groupLayer.addTo(map);

      function createLightMateria() {
        const canvasDom = document.createElement("canvas");
        const size = 32;
        canvasDom.width = size;
        canvasDom.height = size;
        const ctx = canvasDom.getContext("2d");

        ctx.fillStyle = "rgba(86, 197, 234)";
        ctx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
        ctx.fill();
        console.log(canvasDom.toDataURL());

        // ctx.fillRect(0, 0, canvasDom.width, canvasDom.height);

        const texture = new THREE.Texture(canvasDom);
        texture.needsUpdate = true; //使用贴图时进行更新
        return texture;
      }

      var points = [],
        selectMesh = [];
      const material = new THREE.PointsMaterial({
        // size: 10,
        sizeAttenuation: false,
        // color: "rgba(86, 197, 234, 0.3)",
        // alphaTest: 0.5,
        // vertexColors: THREE.VertexColors,
        //  transparent: true
        // color: 0xffffff,
        size: 5,
        transparent: true, //使材质透明
        // blending: THREE.AdditiveBlending,
        depthTest: true, //深度测试关闭，不消去场景的不可见面
        depthWrite: false,
        map: createLightMateria(), //刚刚创建的粒子贴图就在这里用上
        blending: THREE.AdditiveBlending,
      });

      function addPoints(scene) {
        fetch(
          "https://gw.alipayobjects.com/os/basement_prod/513add53-dcb2-4295-8860-9e7aa5236699.json"
        )
          .then(function (res) {
            return res.json();
          })
          .then(function (json) {
            debugger;
            const data = json.features
              .slice(0, Infinity)
              .map(function (dataItem) {
                dataItem = gcoord.transform(
                  dataItem,
                  gcoord.AMap,
                  gcoord.WGS84
                );
                return {
                  coordinate: dataItem.geometry.coordinates,
                  height: 0,
                  value: Math.random() * 10000,
                };
              });
            const point = threeLayer.toPoints(data, {}, material);
            points.push(point);
            threeLayer.addMesh(points);
          });
        // animation();
        // initGui();
      }

      /* function animation() {
        // layer animation support Skipping frames
        threeLayer._needsUpdate = !threeLayer._needsUpdate;
        if (threeLayer._needsUpdate) {
          threeLayer.redraw();
        }
        requestAnimationFrame(animation);
      } */
    </script>
  </body>
</html>
